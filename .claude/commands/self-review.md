---
description: 現在の変更ファイルをコードレビューエージェントで自動レビューします
---

# /self-review

現在の変更ファイルをコードレビューエージェントで自動レビューします。P0/P1項目を修正後、自動で再レビュー（最大3回）。

## 目的

コミット前に変更ファイルの品質をチェックし、アーキテクチャ原則やコーディング規約の違反を検出します。

## 実行内容

1. `git status` で変更ファイルを自動検出
2. コードレビューエージェント（`.claude/agents/code-reviewer.md`）を呼び出し
3. 優先度付きレビュー結果を表示
4. P0/P1項目があれば、修正を実施
5. 修正後、自動で再レビュー（最大3回まで繰り返し）
6. P0/P1がゼロになったらコミット可能と通知

## 使用方法

```bash
/self-review
```

引数は不要です。現在の変更ファイルを自動的に検出してレビューします。

## 実行フロー

```markdown
# ステップ1: 変更ファイルを検出
git status --short

# ステップ2: 変更ファイルをレビュー（初回）
Task(
  subagent_type="general-purpose",
  prompt="`.claude/agents/code-reviewer.md`の指示に従って、以下の変更ファイルをレビューしてください。files: <検出されたファイルリスト>"
)

# ステップ3: レビュー結果を表示
レビューエージェントからの結果を整形して表示

# ステップ4: P0/P1項目があれば修正を実施
- AskUserQuestion でどの項目を修正するか確認
- 選択された項目の修正を実施
- テスト実行（./gradlew test）

# ステップ5: 修正後に再レビュー（自動）
- 再度 git status で変更ファイルを検出
- code-reviewer エージェントで再レビュー
- P0/P1がゼロになるまで最大3回まで繰り返し（ステップ4-5）

# ステップ6: 最終判定
- P0/P1がゼロ: コミット可能と通知
- 最大再試行回数到達: 残課題を報告してユーザーに判断を委ねる
- P2/P3のみの場合: コミット可能と通知
- 問題なしの場合: 品質良好と通知
```

## 再レビューループの制御

- **最大再試行回数**: 3回まで
- **ループ終了条件**: P0/P1項目がゼロになる
- **無限ループ防止**: 3回の再レビュー後もP0/P1が残る場合は、残課題を報告してユーザーに判断を委ねる

## レビュー対象ファイル

このコマンドは主に**Kotlinソースコード（`*.kt`）**をレビューします。以下のファイルは自動的に除外されます:

- ビルド成果物（`*.apk`, `*.class`, `build/`配下）
- 設定ファイル（`gradle.properties`, `local.properties`）
- Gradleビルドスクリプト（`*.gradle`, `*.gradle.kts`）
- XMLリソース（`res/layout/*.xml`, `res/values/*.xml`）※通常は使用しないが存在する場合
- テストリソースファイル（`src/test/resources/`, `src/androidTest/resources/`）

**注意:** ドキュメント（`*.md`）はコード品質チェックの対象外ですが、リクエストによっては含めることができます。

## 推奨される使用タイミング

### ケース1: 新機能実装後

```bash
# 実装完了
(テスト実行コマンド)

# セルフレビュー（P0/P1項目を自動修正→再レビュー）
/self-review

# P0/P1がゼロになったらコミット可能と通知される
git add .
git commit -m "feat: 新機能追加"
```

### ケース2: バグ修正後

```bash
# バグ修正完了
(テスト実行コマンド)

# セルフレビュー（P0/P1項目を自動修正→再レビュー）
/self-review

# P0/P1がゼロになったらコミット可能と通知される
git add .
git commit -m "fix: バグ修正"
```

### ケース3: レビュー指摘対応後

```bash
# レビュー指摘を修正
(テスト実行コマンド)

# セルフレビュー（新たな問題が混入していないか確認）
# P0/P1があれば自動修正→再レビュー
/self-review

# P0/P1がゼロになったらコミット可能と通知される
git add .
git commit -m "fix: レビュー指摘対応"
```

## レビュー結果の見方

### P0 (Blocker) - 必須修正

プロジェクト原則の重大違反。必ず修正してからコミットしてください。

**例:**

- SSOT原則違反（システムAPI直接使用）

### P1 (Critical) - 重要

アーキテクチャ違反。可能な限り修正してください。

**例:**

- イベント駆動違反（手動状態更新）
- WorkManagerフラグ管理違反

### P2 (Important) - 推奨

コーディング規約違反。余裕があれば修正してください。

**例:**

- マジックナンバー
- UI文言ハードコーディング

### P3 (Minor) - 改善提案

より良い実装方法の提案。将来的な改善として記録してください。

**例:**

- リファクタリング提案
- パフォーマンス最適化

## エラーケース

以下の場合はスキップされます:

- 変更ファイルが存在しない（`git status` が空）
- すべてのファイルがレビュー対象外
- Kotlinファイル（`*.kt`）の変更がない

## 関連コマンド

- **`/fix-review`**: GitHubのPRレビュー指摘に対応（他者からのレビュー）
- **`/self-review`**: セルフレビュー（自分の変更チェック）← このコマンド

## 参照ドキュメント

- **[.claude/agents/code-reviewer.md](.claude/agents/code-reviewer.md)**: コードレビューエージェントの詳細
- **[CLAUDE.md](../../CLAUDE.md#推奨開発フロー修正レビューコミット)**: 推奨開発フロー
- **[docs/architecture/](../../docs/architecture/)**: アーキテクチャ原則
- **[docs/guides/coding-standards.md](../../docs/guides/coding-standards.md)**: コーディング規約
