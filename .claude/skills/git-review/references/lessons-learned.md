# git-reviewスキルの教訓

このドキュメントは、PR #399のレビュー対応で得られたgit-reviewスキルの教訓をまとめたものです。

---

## 📚 目次

- [レビュー指摘の優先度判定](#レビュー指摘の優先度判定)
- [AskUserQuestionの効果的な活用](#askuserquestionの効果的な活用)
- [対応済み判定の注意点](#対応済み判定の注意点)
- [レビュー対応フロー](#レビュー対応フロー)

---

## レビュー指摘の優先度判定

### 優先度の基準

レビュー指摘には以下の優先度を設定します:

| 優先度 | 説明 | 対応期限 | 例 |
|-------|------|---------|-----|
| **P0** | ビルドエラー、実行時クラッシュ | 即座 | 型不一致、SQLエラー |
| **P1** | データ損失、機能不全 | マージ前必須 | FTSトリガーUPDATE、予約語エスケープ |
| **P2** | パフォーマンス、保守性 | マージ前推奨 | メモリ効率、コメント修正 |
| **P3** | 軽微な改善提案 | マージ後でも可 | 未使用コード削除 |

### 優先度判定の実例（PR #399）

#### P0: ビルドエラー

```
currentPagingSourceの型不一致
- 現象: VoiceMemoPagingSource?にVoiceMemoSearchPagingSourceを代入できない
- 影響: ビルドが失敗し、アプリ全体がコンパイルできない
- 対応: 基底型PagingSource<Int, VoiceMemo>?に変更
```

#### P1: 機能不全

```
FTSトリガーのUPDATE処理
- 現象: UPDATE文がSQLiteExceptionを引き起こす
- 影響: 文字起こしテキストの更新が全て失敗、検索機能が動作しない
- 対応: DELETE + INSERTパターンに変更
```

```
FTS予約語をエスケープせず検索が失敗
- 現象: "and", "or"などの単語で検索するとSQLエラー
- 影響: ユーザーが一般的な英単語で検索できない
- 対応: 予約語を引用符で囲む処理を追加
```

```
検索結果のソート順問題
- 現象: created_atが現在時刻になり、録音日時順にならない
- 影響: 再インデックス後、全てのメモのソート順が狂う
- 対応: upsertTranscriptTextにcreatedAtパラメータを追加
```

```
アポストロフィ未エスケープ
- 現象: "Bob's"などでSQLiteException: unclosed quote
- 影響: アポストロフィを含む検索ができない、ページングがクラッシュ
- 対応: シングルクォートとコロンを特殊文字セットに追加
```

#### P2: パフォーマンス

```
メモリ効率の改善
- 現象: 全件取得後にメモリでページング
- 影響: 検索結果が数千件になるとOutOfMemoryError
- 対応: LIMIT OFFSETでDBレベルでページング
```

---

## AskUserQuestionの効果的な活用

### 基本原則

git-reviewスキルでは、**必ずAskUserQuestionを使用**してユーザーに対応項目を選択させます。

### ⚠️ AskUserQuestionの制限事項

**重要**: AskUserQuestionには以下の制限があります：

- **1つの質問で最大4つの選択肢まで**
- 5つ以上の指摘がある場合、優先度の高いものを選んで提示
- 残りの指摘は「次回対応」として明示

### 優先度に基づく選択肢の絞り込み

指摘が5つ以上ある場合の対応方法：

1. **P0指摘を優先**: P0が4つ以下なら全て提示
2. **P0 + P1**: P0が少ない場合、P1を追加して最大4つ
3. **P1のみ**: P0が0個の場合、P1の上位4つを提示
4. **残りを明示**: 次回対応する指摘をリスト化

**例（指摘が6件の場合）**:

```
⚠️ 指摘が6件あります。P0/P1の4件のみ表示します。
残り2件（P3）は次回対応してください。

【今回対応】
- [P0] デバッグログレベル修正
- [P1] FTSトリガーのUPDATE処理
- [P2] FtsQueryEscaperコメント修正
- [P2] combine関数可読性向上

【次回対応】
- [P3] 未使用関数の整理
- [P3] クロスプラットフォーム対応
```

### multiSelectの活用

複数の指摘事項を一度に提示し、`multiSelect: true`で効率的な対応を実現します（最大4つまで）。

```kotlin
AskUserQuestion(
    questions = listOf(
        Question(
            question = "どのレビュー指摘に対応しますか？（複数選択可）",
            header = "レビュー対応",
            multiSelect = true,
            options = listOf(
                Option(
                    label = "[P1] FTSトリガーのUPDATE処理",
                    description = "VoxmentDatabase.kt - UPDATE → DELETE+INSERT"
                ),
                Option(
                    label = "[P1] FTS予約語のエスケープ",
                    description = "FtsQueryEscaper.kt - 予約語を引用符で囲む"
                ),
                // ... 他の選択肢
            )
        )
    )
)
```

### 選択肢の設計

#### ✅ 良い選択肢

- **簡潔なラベル**: `[P1] FTSトリガーのUPDATE処理`
- **詳細な説明**: `VoxmentDatabase.kt - UPDATE → DELETE+INSERT`
- **優先度表示**: `[P0]`, `[P1]`, `[P2]`で視覚的に識別

#### ❌ 悪い選択肢

- **長すぎるラベル**: `VoxmentDatabase.ktのFTSトリガーのUPDATE処理が実行時エラーを引き起こす`
- **説明不足**: `修正する`
- **優先度不明**: 優先度バッジなし

---

## 対応済み判定の注意点

### 落とし穴

**コミット履歴だけでは不十分**です。最新のコードを実際に読んで確認する必要があります。

### PR #399での実例

#### ケース1: 対応済みと誤判定

```
レビュー指摘: FTSトリガーのUPDATE処理問題
コミット履歴: "fix: FTS4トリガーのUPDATE処理を修正してSQLiteException回避"

❌ 誤判定: コミットメッセージから対応済みと判断
✅ 正解: 実際にコードを読んでDELETE + INSERTパターンを確認
```

#### ケース2: 部分対応の見逃し

```
レビュー指摘: FTS予約語のエスケープ不足
コミット1: "fix: FTS予約語エスケープ追加" → "or"*形式で追加
コミット2: "fix: FTS予約語エスケープでワイルドカード削除" → "or"形式に修正

❌ 誤判定: コミット1で対応済みと判断
✅ 正解: コミット2で完全対応したことを確認
```

### 確認手順

1. **コミット履歴を確認**: 該当の修正コミットがあるか
2. **コードを直接読む**: 最新のコードで修正が正しく反映されているか
3. **ビルドログを確認**: コンパイルエラーがないか
4. **レビューコメントを再確認**: 指摘内容と修正内容が一致しているか

---

## レビュー対応フロー

### 標準フロー

```
1. git-reviewスキル実行
   ↓
2. PR情報取得・コメント解析
   ↓
3. 指摘事項をリスト化（優先度順）
   ↓
4. AskUserQuestionで選択肢提示
   ↓
5. ユーザーが対応項目を選択
   ↓
6. 選択された項目の詳細を返す
   ↓
【ここからメインエージェント】
7. TodoWriteでタスクリスト作成
   ↓
8. 修正実施（ファイル読み込み→編集→ビルド）
   ↓
9. git-commit-pushスキルでコミット・プッシュ
   ↓
10. git-reviewスキル再実行（新しい指摘確認）
```

### 繰り返しパターン

レビュー指摘が複数回来る場合、以下のサイクルを繰り返します:

```
git-review → 修正 → commit → push → git-review → ...
```

このサイクルで**必ず最新のコードを確認**することが重要です。

---

## ベストプラクティス

### ✅ 推奨

1. **優先度順に対応**: P0 → P1 → P2 → P3の順で修正
2. **AskUserQuestionで選択**: 自動的に全て対応しない
3. **コードを直接読む**: コミットメッセージだけで判断しない
4. **ビルドを確認**: 修正後は必ずビルド成功を確認
5. **git-review再実行**: 修正後に新しい指摘がないか確認

### ❌ 避けるべき

1. **コミットメッセージのみで判断**: 実際のコードを読まない
2. **一度に全て対応**: ユーザーに確認せず自動的に修正
3. **優先度無視**: 軽微な指摘から対応してP0を放置
4. **ビルド省略**: 修正後のビルド確認を省略
5. **再確認しない**: 修正後にgit-reviewを実行しない

---

## チェックリスト

git-reviewスキル実行時の確認項目:

- [ ] PR番号を正しく取得
- [ ] コード行コメントとPR全体コメントの両方を取得
- [ ] 指摘事項に優先度（P0/P1/P2/P3）を付与
- [ ] AskUserQuestionで選択肢を提示（multiSelect: true）
- [ ] 選択された項目の詳細情報をメインエージェントに返す
- [ ] 【メインエージェント】TodoWriteでタスクリスト作成
- [ ] 【メインエージェント】修正を実施
- [ ] 【メインエージェント】ビルド成功を確認
- [ ] 【メインエージェント】git-commit-pushでコミット・プッシュ
- [ ] 【メインエージェント】git-reviewで新しい指摘確認

---

## 参考実装

- `.claude/skills/git-review/SKILL.md` - git-reviewスキルの仕様
- `docs/guides/coding-standards.md` - コーディング規約

---

**最終更新**: 2025-10-18 (PR #399の知見を反映)
